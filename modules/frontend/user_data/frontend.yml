#cloud-config
package_update:  true
package_upgrade: true
timezone: ${TIMEZONE}

disable_root: true
ssh_pwauth:   false

users:
  - name: admin
    ssh-authorized-keys:
      - ${ADMIN_SSH_KEY}
    groups: sudo
    shell: /bin/bash
  - name: manager
    ssh-authorized-keys:
      - ${MANAGER_SSH_KEY}
    groups: sudo
    shell: /bin/bash
    
runcmd:
 - export _PRIVATE_IP=$(curl -s http://169.254.169.254/metadata/v1/interfaces/private/0/ipv4/address)
 - systemctl daemon-reload
 - sed -i -e '/^Port/s/^.*$/Port ${SSH_PORT}/' /etc/ssh/sshd_config
 - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
 - sed -i -e "/^AddressFamily/s/^.*$/AddressFamily inet/" /etc/ssh/sshd_config
 - sed -i -e "/^ListenAddress/s/^.*$/ListenAddress $${_PRIVATE_IP}/" /etc/ssh/sshd_config
 - systemctl restart sshd
 - sed -i "s/listen 80/listen $${_PRIVATE_IP}:80 proxy_protocol/" /etc/nginx/sites-available/magento2.conf
 - systemctl restart nginx
